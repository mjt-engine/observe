(function(c,f){typeof exports=="object"&&typeof module<"u"?f(exports):typeof define=="function"&&define.amd?define(["exports"],f):(c=typeof globalThis<"u"?globalThis:c||self,f(c.Module={}))})(this,function(c){"use strict";const f=t=>{const e=t.split("."),n=e.shift(),r=e.join(".");return{root:n,segments:e,subpath:r}},h=t=>t==null||Number.isNaN(t),v={isDefined:t=>!h(t),isUndefined:h},{isDefined:m,isUndefined:O}=v,$=(t,e,n)=>{if(O(t))return;const r=e.get(t);if(m(r))return r;if(m(n)){const s=n();return e.set(t,s),s}},y={create:()=>{const t=new Map;let e=performance.now();const n={get:(r,s)=>$(r,t,s),set:(r,s)=>(t.set(r,s),n),delete:r=>t.delete(r),entries:()=>Array.from(t.entries()),clear:()=>t.clear(),size:()=>t.size,findKeys:r=>Array.from(t.entries()).filter(([a,u])=>u===r).map(([a,u])=>a),lastUpdate:()=>e};return n}},L=t=>e=>{if(typeof t=="string")return new RegExp(t).test(e.traceId);const{traceId:n,message:r,extra:s=()=>!0,timestamp:a=()=>!0}=t;return!(n&&!new RegExp(n).test(e.traceId)||r&&!new RegExp(r).test(e.message)||e.timestamp&&!a(e.timestamp)||e.extra&&!s(e.extra))},A=t=>e=>{for(const n of t)if(L(n)(e))return n;return!1},C=t=>e=>typeof t=="string"?e:t.transform?t.transform(e):e,d=t=>{const e=[],n={length:0,push:r=>{e.length>=t&&e.shift(),e.push(r),n.length=e.length},get:()=>e,clear:()=>{e.length=0,n.length=0},last:()=>e[e.length-1]};return n},p=()=>{let t=performance.now(),e;const n={end:()=>(m(e)||(e=performance.now()),n),getDuration:()=>(e??performance.now())-t};return n},w=(t=100)=>{let e=0;const n=new Map,r=new Map,s=new Map,a=d(t),u={clear:()=>(e=0,n.clear(),r.clear(),s.clear(),a.clear(),u),lastTime:()=>a.last(),time:()=>{const o=u.lastTime();m(o)&&o.end();const i=p();return a.push(i),i},getTimes:()=>a.get(),timer:o=>{const i=s.get(o)??d(t);s.set(o,i);const g=p();return i.push(g),g},increment:(o,i=1)=>{const g=n.get(o)??0;n.set(o,g+i)},gauge:(o,i=0)=>{r.set(o,i)},getCounters:()=>new Map(n),getCounter:o=>n.get(o)??0,getGauge:o=>r.get(o)??0,getGauges:()=>new Map(r),count:(o=1)=>{e+=o},getCount:()=>e,getTimers:o=>(s.get(o)??d(t)).get()};return u},M=({logMatchers:t=[],logger:e=console.log,clock:n=performance,maxSampleSize:r=100}={})=>{const s=y.create(),a={getTraceIds:()=>s.entries().map(([u])=>u),start:(u,...o)=>{a.getStats(u).count(),a.getStats(u).time(),a.log({traceId:u,message:"start",extra:o})},getStats:u=>s.get(u,()=>w(r)),log:({traceId:u,message:o,timestamp:i=n.now(),extra:g=[]})=>{const S={traceId:u,message:o,timestamp:i,extra:g},b=A(t)(S);if(!b)return;const l=C(b)(S);e(`${l.timestamp} ${l.traceId}: ${l.message}`,...l.extra??[])},end:(u,...o)=>{a.getStats(u).lastTime()?.end(),a.log({traceId:u,message:"end",extra:o})}};return a},T=(t="",e=M())=>{e.start(t);const n={span:r=>T(`${t}.${r}`,e),increment:(r,s=1)=>(e.getStats(t).increment(r,s),n),sample:(r,s,a)=>{if(Math.random()<r){const u=a();n.gauge(s,u)}return n},when:(r,s,a)=>{if(r()){const u=a();n.gauge(s,u)}return n},gauge:(r,s)=>(e.getStats(t).gauge(r,s),n),timer:r=>e.getStats(t).timer(r),end:()=>(e.end(t),n),log:(r,...s)=>(e.log({traceId:t,message:r,extra:s}),n)};return n};c.Observe=T,c.ObserveAgent=M,c.Stats=w,c.Timer=p,c.parseTraceId=f,Object.defineProperty(c,Symbol.toStringTag,{value:"Module"})});
